<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/style.css" rel="stylesheet">
  <title>背默英文生字</title>
</head>
<body class="min-vh-100 d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);">
  <div class="container bg-white bg-opacity-10 border border-light border-opacity-20 rounded p-4 shadow">
    <h1 class="text-center text-white mb-4">背默英文生字</h1>
    
    <!-- 選擇或創建生字庫 -->
    <div id="wordlistSection" class="mb-4">
      <h2 class="text-center text-white mb-4">生字庫管理</h2>
      <div class="mb-3">
        <label for="wordlistSelect" class="form-label text-white">選擇現有生字庫</label>
        <div class="input-group">
          <select id="wordlistSelect" class="form-select mb-2">
            <option value="">-- 選擇生字庫 --</option>
            <% wordlists.forEach(wordlist => { %>
              <option value="<%= wordlist.id %>"><%= wordlist.name %></option>
            <% }) %>
          </select>
          <button onclick="deleteWordlist()" class="btn btn-danger mb-2" disabled id="deleteWordlistBtn">刪除</button>
        </div>
        <button onclick="loadWordlist()" class="btn btn-primary w-100">載入生字庫</button>
      </div>
      <div class="mb-3">
        <label for="wordlistName" class="form-label text-white">或輸入新生字庫名稱</label>
        <input type="text" id="wordlistName" class="form-control mb-2" placeholder="輸入生字庫名稱">
      </div>
    </div>

    <!-- 輸入生字及中文解釋區域 -->
    <div id="inputSection" class="mb-4">
      <p class="text-white text-opacity-75 mb-2">每行輸入一個生字，格式：英文,中文</p>
      <pre class="text-white text-opacity-75 bg-dark bg-opacity-25 p-2 rounded mb-2">
範例：Apple,蘋果
      </pre>
      <textarea id="wordInput" class="form-control mb-2" rows="5" placeholder="輸入英文,中文（每行一個生字）"></textarea>
      <button onclick="saveWords()" class="btn btn-primary w-100">儲存生字</button>
    </div>

    <!-- 生字列表區域 -->
    <div id="wordListSection" class="mb-4 d-none">
      <h2 class="text-center text-white mb-4">生字列表</h2>
      <!-- 新增生字輸入區域 -->
      <div class="mb-3">
        <label class="form-label text-white">新增生字</label>
        <div class="input-group">
          <input type="text" id="newWordEnglish" class="form-control" placeholder="英文單字">
          <input type="text" id="newWordChinese" class="form-control" placeholder="中文解釋">
          <button onclick="addNewWord()" class="btn btn-success">新增</button>
        </div>
      </div>
      <ul id="wordList" class="list-group mb-4"></ul>
      <button onclick="saveEditedWords()" class="btn btn-primary w-100 mb-2">儲存編輯</button>
      <button onclick="startQuiz()" class="btn btn-primary w-100">開始背默</button>
      <button onclick="resetQuiz()" class="btn btn-secondary w-100 mt-2">重新開始</button>
    </div>

    <!-- 背默區域 -->
    <div id="quizSection" class="d-none">
      <p class="text-white mb-2">請輸入以下中文解釋對應的英文單字：</p>
      <p id="currentMeaning" class="text-center text-info mb-4 fs-4"></p>
      <input id="userInput" type="text" class="form-control mb-2" placeholder="輸入英文單字" onkeypress="if(event.key === 'Enter') checkAnswer()">
      <button onclick="checkAnswer()" class="btn btn-primary w-100">檢查答案</button>
      <p id="result" class="mt-2 text-center"></p>
      <button onclick="resetQuiz()" class="btn btn-secondary w-100 mt-2">重新開始</button>
    </div>

    <!-- 結果區域 -->
    <div id="resultSection" class="d-none">
      <h2 class="text-center text-white mb-4">背默結果</h2>
      <p id="resultSummary" class="text-center text-white mb-4"></p>
      <ul id="resultDetails" class="list-group mb-4"></ul>
      <button onclick="resetQuiz()" class="btn btn-secondary w-100">重新開始</button>
    </div>
  </div>

  <script>
    let words = [];
    let usedIndices = [];
    let currentWordIndex = -1;
    let results = [];
    let currentWordlistId = null;

    // 當選擇生字庫時啟用刪除按鈕
    document.getElementById('wordlistSelect').addEventListener('change', function() {
      const deleteBtn = document.getElementById('deleteWordlistBtn');
      deleteBtn.disabled = this.value === '';
    });

    function saveWords() {
      const wordlistName = document.getElementById('wordlistName').value.trim();
      const input = document.getElementById('wordInput').value.trim();
      if (!wordlistName) {
        alert('請輸入生字庫名稱！');
        return;
      }
      const lines = input.split('\n').map(line => line.trim()).filter(line => line);
      words = lines.map(line => {
        const [english, chinese] = line.split(',').map(item => item.trim());
        return { english, chinese };
      }).filter(word => word.english && word.chinese);
      
      if (words.length === 0) {
        alert('請至少輸入一個有效的生字及中文解釋（格式：英文,中文）！');
        return;
      }

      // 使用 AJAX 儲存生字庫
      fetch('/dictation/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ wordlistName, words })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          currentWordlistId = data.wordlistId;
          document.getElementById('inputSection').classList.add('d-none');
          document.getElementById('wordlistSection').classList.add('d-none');
          document.getElementById('wordListSection').classList.remove('d-none');
          displayWordList();
          // 更新生字庫選單
          const select = document.getElementById('wordlistSelect');
          const option = document.createElement('option');
          option.value = data.wordlistId;
          option.textContent = wordlistName;
          select.appendChild(option);
        } else {
          alert(data.error || '儲存生字庫失敗，請稍後重試');
        }
      })
      .catch(err => {
        console.error('Save Error:', err);
        alert('儲存生字庫失敗，請稍後重試');
      });
    }

    function loadWordlist() {
      const wordlistId = document.getElementById('wordlistSelect').value;
      if (!wordlistId) {
        alert('請選擇一個生字庫！');
        return;
      }

      // 使用 AJAX 取得生字庫中的生字
      fetch(`/dictation/words/${wordlistId}`)
      .then(response => response.json())
      .then(data => {
        words = data;
        currentWordlistId = wordlistId;
        if (words.length > 0) {
          document.getElementById('wordlistSection').classList.add('d-none');
          document.getElementById('inputSection').classList.add('d-none');
          document.getElementById('wordListSection').classList.remove('d-none');
          displayWordList();
        } else {
          alert('該生字庫為空！');
        }
      })
      .catch(err => {
        console.error('Load Error:', err);
        alert('載入生字庫失敗，請稍後重試');
      });
    }

    function deleteWordlist() {
      const wordlistId = document.getElementById('wordlistSelect').value;
      if (!wordlistId) {
        alert('請選擇一個生字庫！');
        return;
      }
      if (!confirm('確定要刪除此生字庫嗎？此操作無法恢復！')) {
        return;
      }

      // 使用 AJAX 刪除生字庫
      fetch(`/dictation/wordlist/${wordlistId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const select = document.getElementById('wordlistSelect');
          const option = select.querySelector(`option[value="${wordlistId}"]`);
          option.remove();
          select.value = '';
          document.getElementById('deleteWordlistBtn').disabled = true;
          alert('生字庫已刪除！');
        } else {
          alert(data.error || '刪除生字庫失敗，請稍後重試');
        }
      })
      .catch(err => {
        console.error('Delete Error:', err);
        alert('刪除生字庫失敗，請稍後重試');
      });
    }

    function addNewWord() {
      if (!currentWordlistId) {
        alert('請先載入或儲存一個生字庫！');
        return;
      }
      const english = document.getElementById('newWordEnglish').value.trim();
      const chinese = document.getElementById('newWordChinese').value.trim();
      if (!english || !chinese) {
        alert('請輸入英文單字和中文解釋！');
        return;
      }

      // 使用 AJAX 新增單個生字
      fetch(`/dictation/word/${currentWordlistId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ english, chinese })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          words.push({ id: data.wordId, english, chinese });
          document.getElementById('newWordEnglish').value = '';
          document.getElementById('newWordChinese').value = '';
          displayWordList();
          alert('生字已新增！');
        } else {
          alert(data.error || '新增生字失敗，請稍後重試');
        }
      })
      .catch(err => {
        console.error('Add Word Error:', err);
        alert('新增生字失敗，請稍後重試');
      });
    }

    function displayWordList() {
      const wordList = document.getElementById('wordList');
      wordList.innerHTML = '';
      words.forEach((word, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item bg-dark bg-opacity-25 text-white d-flex align-items-center';
        li.innerHTML = `
          <input type="text" class="form-control mx-2" style="width: 150px;" value="${word.english}" data-index="${index}" data-field="english">
          <span>-</span>
          <input type="text" class="form-control mx-2" style="width: 150px;" value="${word.chinese}" data-index="${index}" data-field="chinese">
          <button class="btn btn-sm btn-info mx-1" onclick="speakWord('${word.english}')">發音</button>
          <button class="btn btn-sm btn-warning mx-1" onclick="editWord(${index})">編輯</button>
          <button class="btn btn-sm btn-danger" onclick="deleteWord(${index})">刪除</button>
        `;
        wordList.appendChild(li);
      });
    }

    function editWord(index) {
      const englishInput = document.querySelector(`input[data-index="${index}"][data-field="english"]`);
      const chineseInput = document.querySelector(`input[data-index="${index}"][data-field="chinese"]`);
      words[index].english = englishInput.value.trim();
      words[index].chinese = chineseInput.value.trim();
    }

    function deleteWord(index) {
      if (confirm('確定要刪除此生字嗎？')) {
        words.splice(index, 1);
        displayWordList();
      }
    }

    function saveEditedWords() {
      if (!currentWordlistId) {
        alert('請先載入或儲存一個生字庫！');
        return;
      }

      // 使用 AJAX 更新生字庫
      fetch(`/dictation/words/${currentWordlistId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ words })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('生字已更新！');
          displayWordList();
        } else {
          alert(data.error || '更新生字失敗，請稍後重試');
        }
      })
      .catch(err => {
        console.error('Update Error:', err);
        alert('更新生字失敗，請稍後重試');
      });
    }

    function speakWord(word) {
      const utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = 'en-US';
      window.speechSynthesis.speak(utterance);
    }

    function startQuiz() {
      document.getElementById('wordListSection').classList.add('d-none');
      document.getElementById('quizSection').classList.remove('d-none');
      usedIndices = [];
      results = [];
      nextWord();
    }

    function nextWord() {
      if (usedIndices.length >= words.length) {
        showResults();
        return;
      }

      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * words.length);
      } while (usedIndices.includes(newIndex));
      
      usedIndices.push(newIndex);
      currentWordIndex = newIndex;
      document.getElementById('currentMeaning').textContent = words[currentWordIndex].chinese;
      document.getElementById('userInput').value = '';
      document.getElementById('result').textContent = '';
      document.getElementById('userInput').focus();
    }

    function checkAnswer() {
      const userAnswer = document.getElementById('userInput').value.trim().toLowerCase();
      const correctAnswer = words[currentWordIndex].english.toLowerCase();
      const resultElement = document.getElementById('result');
      
      const isCorrect = userAnswer === correctAnswer;
      results.push({
        english: words[currentWordIndex].english,
        chinese: words[currentWordIndex].chinese,
        userAnswer,
        isCorrect
      });

      if (isCorrect) {
        resultElement.textContent = '正確！';
        resultElement.className = 'mt-2 text-center text-success';
      } else {
        resultElement.textContent = `錯誤，正確答案是：${words[currentWordIndex].english}`;
        resultElement.className = 'mt-2 text-center text-danger';
      }

      speakWord(words[currentWordIndex].english);

      if (usedIndices.length < words.length) {
        setTimeout(nextWord, 2000);
      } else {
        setTimeout(showResults, 2000);
      }
    }

    function showResults() {
      document.getElementById('quizSection').classList.add('d-none');
      document.getElementById('resultSection').classList.remove('d-none');
      
      const correctCount = results.filter(r => r.isCorrect).length;
      const totalCount = results.length;
      const summary = `你答對了 ${correctCount} / ${totalCount} 個單字！`;
      document.getElementById('resultSummary').textContent = summary;

      const detailsList = document.getElementById('resultDetails');
      detailsList.innerHTML = '';
      results.forEach(result => {
        const li = document.createElement('li');
        li.className = `list-group-item ${result.isCorrect ? 'text-success' : 'text-danger'}`;
        li.innerHTML = `<span class="cursor-pointer text-info" onclick="speakWord('${result.english}')">${result.english}</span> (${result.chinese}): 你的答案 - ${result.userAnswer || '無'} (${result.isCorrect ? '正確' : '錯誤'})`;
        detailsList.appendChild(li);
      });
    }

    function resetQuiz() {
      document.getElementById('wordlistSection').classList.remove('d-none');
      document.getElementById('inputSection').classList.remove('d-none');
      document.getElementById('wordListSection').classList.add('d-none');
      document.getElementById('quizSection').classList.add('d-none');
      document.getElementById('resultSection').classList.add('d-none');
      document.getElementById('wordInput').value = '';
      document.getElementById('wordlistName').value = '';
      document.getElementById('wordlistSelect').value = '';
      document.getElementById('deleteWordlistBtn').disabled = true;
      document.getElementById('newWordEnglish').value = '';
      document.getElementById('newWordChinese').value = '';
      words = [];
      usedIndices = [];
      currentWordIndex = -1;
      results = [];
      currentWordlistId = null;
    }
  </script>
</body>
</html>